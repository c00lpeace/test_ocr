# Taxonomy용 OCR + VL 통합 설계 정리 문서

## 1. 프로젝트 목표

상품 상세페이지 이미지로부터:

-   OCR 수행
-   노이즈 제거
-   정형 JSON 구조화
-   기존 택소노미 파이프라인에 투입

을 안정적으로 수행하는 시스템 설계.

------------------------------------------------------------------------

# 2. 처리 전략 개요

## ✅ 단일 통합 방식 (VL 모델 1회 호출)

이미지 → VL 모델 → OCR + 정제 + JSON 출력

### 장점

-   파이프라인 단순
-   비용 절감
-   속도 빠름

### 단점

-   긴 이미지에서 토큰 초과 위험
-   일부 정보 누락 가능성

------------------------------------------------------------------------

# 3. 4096 토큰 환경 대응 전략

총 사용량:

\[이미지 토큰\] + \[프롬프트\] + \[출력 JSON\] ≤ 4096

### 권장 예산 분배

-   이미지: 2000\~2500
-   프롬프트: 400\~600
-   출력(JSON): 300\~600
-   여유: 300\~500

### 필수 조치

-   description 200자 제한
-   temperature = 0
-   JSON only 출력 강제

------------------------------------------------------------------------

# 4. 세로 긴 이미지 대응: 분할 전략

## 문제점

-   이미지가 어느 구간인지 모름
-   높이 제각각
-   길 경우 토큰 초과 위험

## 해결 전략

1.  고정 높이 분할 (1400\~1800px)
2.  20\~30% overlap 적용
3.  각 분할 이미지 개별 VL 호출
4.  결과 병합

------------------------------------------------------------------------

# 5. 분할 이미지용 프롬프트 (압축 버전)

-   이미지 일부일 수 있음 명시
-   보이는 텍스트만 사용
-   추측 금지
-   JSON만 출력
-   노이즈 제거 규칙 명시

(description 200자 제한 포함)

------------------------------------------------------------------------

# 6. 병합 전략

## 기본 원칙

-   null 아닌 값 우선
-   배열은 합집합
-   충돌 시 보수적 처리
-   product_name은 가장 긴 값 선택

------------------------------------------------------------------------

## 필드별 병합 요약

### product_name

-   가장 긴 값
-   상단 part 우선

### brand

-   단일 값만 허용
-   다르면 null + conflict flag

### material

-   더 구체적 표현 선택

### origin_country

-   국가명 정규화
-   충돌 시 flag

### color / size

-   합집합 + 중복 제거

### description

-   중복 제거
-   마케팅 문구 제거
-   300자 제한

------------------------------------------------------------------------

# 7. 최종 스키마 (메타 포함)

``` json
{
  "product_name": "...",
  "brand": "...",
  "category": "...",
  "material": "...",
  "origin_country": "...",
  "color": [],
  "size": [],
  "description": "...",
  "meta": {
    "source_parts": 3,
    "conflict": {
      "brand": false,
      "material": false,
      "origin_country": false
    },
    "null_ratio": 0.25
  }
}
```

------------------------------------------------------------------------

# 8. 카테고리별 전략 차이

## 패션

-   상단: 상품명/브랜드
-   중단: 소재/사이즈
-   하단: 정책 (노이즈 비율 높음)

## 뷰티

-   전성분/용량 중요
-   마케팅 문구 제거 중요

## 식품

-   영양성분/원재료 중심
-   하단 정보 중요

## 가전

-   스펙표 인식 중요
-   overlap 크게 (30% 권장)

------------------------------------------------------------------------

# 9. 자동 품질 모니터링 지표

-   null_ratio
-   conflict_rate
-   JSON parse_fail_rate

------------------------------------------------------------------------

# 10. 최종 권장 아키텍처

1.  이미지 길이 판단
2.  필요 시 분할
3.  각 분할 VL 호출
4.  규칙 기반 병합
5.  검증 및 정규화
6.  택소노미 모델 전달

------------------------------------------------------------------------

# 결론

✔ VL 단일 호출 가능\
✔ 긴 이미지 대응 위해 분할 + 병합 권장\
✔ 병합은 LLM이 아닌 코드 기반 권장\
✔ 토큰 예산 관리 필수\
✔ 메타/충돌 플래그 설계가 운영 안정성 핵심
